<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot with Tools</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui; display: flex; flex-direction: column; height: 100vh; background: #1a1a1a; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 10px; word-wrap: break-word; }
        .user { align-self: flex-end; background: #007bff; color: white; }
        .ai { align-self: flex-start; background: #2d2d2d; color: #e0e0e0; }
        .tool-call { align-self: flex-start; background: #3a3a3a; color: #ffa500; padding: 8px 12px; border-radius: 8px; font-size: 0.9em; border-left: 3px solid #ffa500; }
        .weather-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; max-width: 350px; margin: 10px 0; }
        .weather-header { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
        .weather-temp { font-size: 2em; font-weight: bold; }
        .weather-details { margin-top: 10px; font-size: 0.9em; }
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .weather-item { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; }
        .currency-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 12px; max-width: 400px; margin: 10px 0; }
        .currency-header { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .currency-rate { font-size: 1.8em; font-weight: bold; margin: 10px 0; }
        .currency-info { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-top: 10px; }
        .currency-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
        .currency-item { background: rgba(255,255,255,0.1); padding: 6px 10px; border-radius: 6px; display: flex; justify-content: space-between; font-size: 0.9em; }
        .sales-card { background: linear-gradient(135deg, #2a9c8f 0%, #2a7f7f 100%); color: white; padding: 15px; border-radius: 12px; max-width: 400px; margin: 10px 0; }
        .sales-header { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
        .sales-total { font-size: 2em; font-weight: bold; }
        .sales-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .sales-item { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; }
        #input-area { display: flex; padding: 15px; background: #2d2d2d; gap: 10px; }
        #input { flex: 1; padding: 10px; border: none; border-radius: 5px; background: #3d3d3d; color: white; }
        #send { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #send:hover { background: #0056b3; }
        #send:disabled { opacity: 0.5; cursor: not-allowed; }
        .typing { display: inline-block; padding: 8px 12px; background: #3d3d3d; border-radius: 8px; }
        .typing:after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
        .error { background: #ff4444; color: white; }
    </style>
</head>
<body>
    <div id="chat"></div>
    <div id="input-area">
        <input type="text" id="input" placeholder="Ketik pesan, tanya tentang cuaca, atau kurs mata uang..." autofocus>
        <button id="send">Kirim</button>
    </div>

    <script>
        // API Configuration - Using backend proxy
        const DEEPSEEK_API_URL = '/api/deepseek';
        
        // OpenWeatherMap API (Free tier)
        const WEATHER_API_KEY = 'a6b54487d722375e74ecadc169a3257c'; // Ganti dengan API key Anda dari openweathermap.org
        const WEATHER_API_URL = 'https://api.openweathermap.org/data/2.5/weather';
        
        // Exchange Rate API (Free tier)
        const EXCHANGE_API_URL = 'https://api.exchangerate-api.com/v4/latest/';
        
        const chat = document.getElementById('chat');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send');


        /*
        You are a helpful AI assistant with access to real-time weather and currency exchange information. 
                When users ask about weather or currency exchange rates, use the appropriate tool to fetch current data.
                Respond in the same language as the user.
                
                You have access to the following tools:
                - get_weather: Gets current weather for a specified city
                - get_exchange_rate: Gets current exchange rates between currencies
                - get_sales_performance: Gets sales performance data for a specified period
                
                When you need to use a tool, respond with a JSON object in one of these formats:
                {"tool": "get_weather", "city": "city_name"}
                {"tool": "get_exchange_rate", "from": "USD", "to": "IDR", "amount": 100}
                {"tool": "get_sales_performance", "period": "daily|weekly|monthly"}
                
                For currency queries:
                - If no amount is specified, use 1 as default
                - Common currency codes: USD (US Dollar), EUR (Euro), GBP (British Pound), IDR (Indonesian Rupiah), 
                  JPY (Japanese Yen), CNY (Chinese Yuan), SGD (Singapore Dollar), MYR (Malaysian Ringgit), THB (Thai Baht),
                  AUD (Australian Dollar), CAD (Canadian Dollar), CHF (Swiss Franc)
                - You can also show multiple exchange rates if asked
                
                After receiving the data, provide a natural, conversational response.

        */
        let products = "Tipe A, harga 200,000,000\nTipe B Harga 500,000,000"
        let messages = [
            {
                role: "system", 
                content: `
> Kamu adalah asisten virtual untuk **Toko Aki Mobil \[Nama Toko]**, yang menjual aki mobil berbagai merek, memberikan layanan ganti aki, pengecekan aki gratis, dan layanan darurat antar/jemput aki.
>
> **Tugasmu:**
>
> * Jawab pertanyaan pelanggan dengan **singkat, jelas, ramah, dan profesional**.
> * Jika pertanyaan berkaitan dengan **produk, harga, stok, layanan, atau lokasi toko**, berikan informasi yang sesuai.
> * Jika pelanggan ingin **membeli aki**, bantu dengan menanyakan **jenis mobil, tahun mobil, dan budget** untuk rekomendasi aki yang tepat.
> * Jika pelanggan bertanya tentang **layanan darurat ganti aki di tempat**, tanyakan **lokasi pelanggan dan jam layanan yang diinginkan**.
> * Selalu tawarkan opsi: **datang ke toko, delivery aki, atau booking teknisi**.
> * Jika ada pertanyaan di luar topik aki mobil, jawab dengan sopan dan arahkan kembali ke layanan toko.
>
> **Contoh gaya jawaban:**
>
> * ‚ÄúBaik, boleh saya tahu jenis dan tahun mobil Bapak/Ibu agar saya bisa rekomendasikan aki yang sesuai?‚Äù
> * ‚ÄúKami siap antar dan pasang aki ke lokasi Anda. Bisa dibantu info lokasinya?‚Äù
> * ‚ÄúPromo bulan ini: tukar tambah aki lama dapat potongan Rp100.000.‚Äù
>
> Selalu akhiri dengan **ajakan bertindak** (misalnya: *‚ÄúApakah ingin dibantu pesan sekarang?‚Äù*).


`
+
products
                }
        ];
        
        function addMessage(content, className) {
            const div = document.createElement('div');
            div.className = `msg ${className}`;
            if (typeof content === 'string') {
                div.textContent = content;
            } else {
                div.appendChild(content);
            }
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            return div;
        }
        
        function showTyping() {
            const typing = document.createElement('div');
            typing.className = 'typing';
            typing.id = 'typing-indicator';
            chat.appendChild(typing);
            chat.scrollTop = chat.scrollHeight;
        }
        
        function hideTyping() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }
        
        function createWeatherCard(data) {
            const card = document.createElement('div');
            card.className = 'weather-card';
            
            const temp = Math.round(data.main.temp);
            const feelsLike = Math.round(data.main.feels_like);
            const humidity = data.main.humidity;
            const windSpeed = Math.round(data.wind.speed * 3.6); // Convert m/s to km/h
            
            card.innerHTML = `
                <div class="weather-header">üå§Ô∏è ${data.name}, ${data.sys.country}</div>
                <div class="weather-temp">${temp}¬∞C</div>
                <div style="margin-top: 5px;">${data.weather[0].description}</div>
                <div class="weather-grid">
                    <div class="weather-item">
                        <div style="opacity: 0.8;">Terasa</div>
                        <div style="font-weight: bold;">${feelsLike}¬∞C</div>
                    </div>
                    <div class="weather-item">
                        <div style="opacity: 0.8;">Kelembaban</div>
                        <div style="font-weight: bold;">${humidity}%</div>
                    </div>
                    <div class="weather-item">
                        <div style="opacity: 0.8;">Angin</div>
                        <div style="font-weight: bold;">${windSpeed} km/h</div>
                    </div>
                    <div class="weather-item">
                        <div style="opacity: 0.8;">Tekanan</div>
                        <div style="font-weight: bold;">${data.main.pressure} hPa</div>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        async function getWeather(city) {
            try {
                // Check if API key is set
                if (WEATHER_API_KEY === 'YOUR_OPENWEATHER_API_KEY') {
                    throw new Error('Please set your OpenWeatherMap API key first');
                }
                
                addMessage(`üîß Mengambil data cuaca untuk ${city}...`, 'tool-call');
                
                const response = await fetch(`${WEATHER_API_URL}?q=${encodeURIComponent(city)}&appid=${WEATHER_API_KEY}&units=metric&lang=id`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`Kota "${city}" tidak ditemukan`);
                    }
                    throw new Error('Failed to fetch weather data');
                }
                
                const data = await response.json();
                
                // Display weather card
                const weatherCard = createWeatherCard(data);
                addMessage(weatherCard, '');
                
                return {
                    success: true,
                    data: {
                        city: data.name,
                        country: data.sys.country,
                        temperature: Math.round(data.main.temp),
                        feels_like: Math.round(data.main.feels_like),
                        description: data.weather[0].description,
                        humidity: data.main.humidity,
                        wind_speed: Math.round(data.wind.speed * 3.6),
                        pressure: data.main.pressure
                    }
                };
            } catch (error) {
                console.error('Weather API error:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // Alternative: Get weather using a free proxy service (if OpenWeatherMap API key not available)
        function createCurrencyCard(data) {
            const card = document.createElement('div');
            card.className = 'currency-card';
            
            const rate = data.rate.toFixed(4);
            const result = data.result.toLocaleString('id-ID', { maximumFractionDigits: 2 });
            
            // Currency symbols
            const symbols = {
                USD: '$', EUR: '‚Ç¨', GBP: '¬£', JPY: '¬•', CNY: '¬•',
                IDR: 'Rp', SGD: 'S$', MYR: 'RM', THB: '‡∏ø', AUD: 'A$',
                CAD: 'C$', CHF: 'CHF', KRW: '‚Ç©', INR: '‚Çπ', HKD: 'HK$'
            };
            
            const fromSymbol = symbols[data.from] || data.from;
            const toSymbol = symbols[data.to] || data.to;
            
            let html = `
                <div class="currency-header">
                    <span>üí±</span>
                    <span>Kurs Mata Uang</span>
                </div>
                <div class="currency-rate">
                    ${data.amount} ${data.from} = ${result} ${data.to}
                </div>
                <div class="currency-info">
                    <div style="opacity: 0.9; margin-bottom: 5px;">Rate: 1 ${data.from} = ${rate} ${data.to}</div>
                    <div style="opacity: 0.7; font-size: 0.85em;">Update: ${new Date(data.timestamp * 1000).toLocaleString('id-ID')}</div>
                </div>
            `;
            
            // Add additional rates if available
            if (data.additionalRates) {
                html += '<div class="currency-list">';
                for (const [currency, rate] of Object.entries(data.additionalRates)) {
                    const value = (data.amount * rate).toLocaleString('id-ID', { maximumFractionDigits: 2 });
                    html += `
                        <div class="currency-item">
                            <span>${currency}</span>
                            <span>${value}</span>
                        </div>
                    `;
                }
                html += '</div>';
            }
            
            card.innerHTML = html;
            return card;
        }

        function createSalesCard(data) {
            const card = document.createElement('div');
            card.className = 'sales-card';
            
            card.innerHTML = `
                <div class="sales-header">üìä Laporan Penjualan (${data.period})</div>
                <div class="sales-total">Rp ${data.total_sales.toLocaleString('id-ID')}</div>
                <div class="sales-grid">
                    <div class="sales-item">
                        <div style="opacity: 0.8;">Transaksi</div>
                        <div style="font-weight: bold;">${data.transactions}</div>
                    </div>
                    <div class="sales-item">
                        <div style="opacity: 0.8;">Produk Teratas</div>
                        <div style="font-weight: bold;">${data.top_product}</div>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        async function getSalesPerformance(period = 'daily') {
            try {
                addMessage(`üìà Mengambil data penjualan ${period}...`, 'tool-call');
                
                // Simulate API call to internal database
                const response = await fetch(`/api/sales?period=${period}`);
                
                if (!response.ok) {
                    throw new Error('Gagal mengambil data penjualan');
                }
                
                const data = await response.json();
                
                // Display sales card
                const salesCard = createSalesCard(data);
                addMessage(salesCard, '');
                
                return {
                    success: true,
                    data: data
                };
            } catch (error) {
                console.error('Sales API error:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        async function getExchangeRate(from = 'USD', to = 'IDR', amount = 1) {
            try {
                addMessage(`üí± Mengambil data kurs ${from} ke ${to}...`, 'tool-call');
                
                // Using exchangerate-api.com (free tier, no API key needed)
                const response = await fetch(`${EXCHANGE_API_URL}${from}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch exchange rates');
                }
                
                const data = await response.json();
                
                if (!data.rates[to]) {
                    throw new Error(`Currency ${to} not supported`);
                }
                
                const rate = data.rates[to];
                const result = amount * rate;
                
                // Get additional common currencies for display
                const commonCurrencies = ['USD', 'EUR', 'GBP', 'JPY', 'SGD', 'MYR', 'CNY'];
                const additionalRates = {};
                
                // Only show additional rates if converting a major currency
                if (commonCurrencies.includes(from) && amount === 1) {
                    commonCurrencies.forEach(curr => {
                        if (curr !== from && data.rates[curr]) {
                            additionalRates[curr] = data.rates[curr];
                        }
                    });
                }
                
                const exchangeData = {
                    from: from,
                    to: to,
                    amount: amount,
                    rate: rate,
                    result: result,
                    timestamp: data.time_last_updated,
                    additionalRates: Object.keys(additionalRates).length > 0 ? additionalRates : null
                };
                
                // Display currency card
                const currencyCard = createCurrencyCard(exchangeData);
                addMessage(currencyCard, '');
                
                return {
                    success: true,
                    data: exchangeData
                };
                
            } catch (error) {
                console.error('Exchange rate error:', error);
                
                // Try fallback API (fixer.io free tier simulation)
                try {
                    // Using a mock response for demonstration
                    const mockRates = {
                        USD: { IDR: 15750, EUR: 0.92, GBP: 0.79, JPY: 149.50, SGD: 1.35, MYR: 4.47, CNY: 7.24 },
                        EUR: { IDR: 17100, USD: 1.09, GBP: 0.86, JPY: 162.50, SGD: 1.47, MYR: 4.86, CNY: 7.87 },
                        GBP: { IDR: 19900, USD: 1.27, EUR: 1.16, JPY: 189.00, SGD: 1.71, MYR: 5.65, CNY: 9.15 }
                    };
                    
                    if (mockRates[from] && mockRates[from][to]) {
                        const rate = mockRates[from][to];
                        const result = amount * rate;
                        
                        const exchangeData = {
                            from: from,
                            to: to,
                            amount: amount,
                            rate: rate,
                            result: result,
                            timestamp: Date.now() / 1000
                        };
                        
                        const currencyCard = createCurrencyCard(exchangeData);
                        addMessage(currencyCard, '');
                        
                        return {
                            success: true,
                            data: exchangeData
                        };
                    }
                } catch (e) {
                    // Fallback failed
                }
                
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        async function getWeatherFallback(city) {
            try {
                addMessage(`üîß Mencari informasi cuaca untuk ${city}...`, 'tool-call');
                
                // Using wttr.in as a fallback (free weather service)
                const response = await fetch(`https://wttr.in/${encodeURIComponent(city)}?format=j1`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch weather data');
                }
                
                const data = await response.json();
                const current = data.current_condition[0];
                
                // Create a simple weather display
                const weatherInfo = document.createElement('div');
                weatherInfo.className = 'weather-card';
                weatherInfo.innerHTML = `
                    <div class="weather-header">üå§Ô∏è ${data.nearest_area[0].areaName[0].value}, ${data.nearest_area[0].country[0].value}</div>
                    <div class="weather-temp">${current.temp_C}¬∞C</div>
                    <div style="margin-top: 5px;">${current.weatherDesc[0].value}</div>
                    <div class="weather-grid">
                        <div class="weather-item">
                            <div style="opacity: 0.8;">Terasa</div>
                            <div style="font-weight: bold;">${current.FeelsLikeC}¬∞C</div>
                        </div>
                        <div class="weather-item">
                            <div style="opacity: 0.8;">Kelembaban</div>
                            <div style="font-weight: bold;">${current.humidity}%</div>
                        </div>
                        <div class="weather-item">
                            <div style="opacity: 0.8;">Angin</div>
                            <div style="font-weight: bold;">${current.windspeedKmph} km/h</div>
                        </div>
                        <div class="weather-item">
                            <div style="opacity: 0.8;">Tekanan</div>
                            <div style="font-weight: bold;">${current.pressure} hPa</div>
                        </div>
                    </div>
                `;
                
                addMessage(weatherInfo, '');
                
                return {
                    success: true,
                    data: {
                        city: data.nearest_area[0].areaName[0].value,
                        country: data.nearest_area[0].country[0].value,
                        temperature: parseInt(current.temp_C),
                        feels_like: parseInt(current.FeelsLikeC),
                        description: current.weatherDesc[0].value,
                        humidity: parseInt(current.humidity),
                        wind_speed: parseInt(current.windspeedKmph),
                        pressure: parseInt(current.pressure)
                    }
                };
            } catch (error) {
                console.error('Weather fallback error:', error);
                return {
                    success: false,
                    error: 'Unable to fetch weather data'
                };
            }
        }
        
        async function processToolCall(aiResponse) {
            try {
                // Check if response contains tool call JSON
                // Try to find JSON pattern in the response for weather or exchange rate
                const weatherMatch = aiResponse.match(/\{[^}]*"tool"[^}]*"get_weather"[^}]*\}/);
                const exchangeMatch = aiResponse.match(/\{[^}]*"tool"[^}]*"get_exchange_rate"[^}]*\}/);
                const salesMatch = aiResponse.match(/\{[^}]*"tool"[^}]*"get_sales_performance"[^}]*\}/);
                
                let jsonMatch = weatherMatch || exchangeMatch || salesMatch;
                
                if (!jsonMatch) {
                    // Also try without strict pattern matching
                    try {
                        const parsed = JSON.parse(aiResponse);
                        if (parsed.tool === 'get_weather' && parsed.city) {
                            const weatherResult = await getWeatherFallback(parsed.city);
                            return weatherResult;
                        } else if (parsed.tool === 'get_exchange_rate') {
                            const from = parsed.from || 'USD';
                            const to = parsed.to || 'IDR';
                            const amount = parsed.amount || 1;
                            const exchangeResult = await getExchangeRate(from, to, amount);
                            return exchangeResult;
                        } else if (parsed.tool === 'get_sales_performance') {
                            const period = parsed.period || 'daily';
                            const salesResult = await getSalesPerformance(period);
                            return salesResult;
                        }
                    } catch {
                        return null;
                    }
                    return null;
                }
                
                const parsed = JSON.parse(jsonMatch[0]);
                
                if (parsed.tool === 'get_weather' && parsed.city) {
                    // Always use Open-Meteo API (free, no CORS issues)
                    const weatherResult = await getWeatherFallback(parsed.city);
                    return weatherResult;
                } else if (parsed.tool === 'get_exchange_rate') {
                    const from = parsed.from || 'USD';
                    const to = parsed.to || 'IDR';
                    const amount = parsed.amount || 1;
                    const exchangeResult = await getExchangeRate(from, to, amount);
                    return exchangeResult;
                } else if (parsed.tool === 'get_sales_performance' && parsed.period) {
                    const salesResult = await getSalesPerformance(parsed.period);
                    return salesResult;
                }
            } catch (e) {
                console.error('Tool call parsing error:', e);
                return null;
            }
            return null;
        }
        
        async function sendMessage() {
            const userMsg = input.value.trim();
            if (!userMsg) return;
            
            addMessage(userMsg, 'user');
            messages.push({role: "user", content: userMsg});
            
            input.value = '';
            sendBtn.disabled = true;
            showTyping();
            
            try {
                // First AI response (might be a tool call)
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 1000,
                        stream: false
                    })
                });
                
                if (!response.ok) throw new Error('API Error');
                
                const data = await response.json();
                let aiMsg = data.choices[0].message.content;
                
                hideTyping();
                
                // Check if AI wants to use a tool (pass full response string)
                const toolResult = await processToolCall(aiMsg);
                
                if (toolResult) {
                    // AI made a tool call
                    messages.push({role: "assistant", content: aiMsg});
                    
                    // Add tool result to context
                    let toolResponseMsg;
                    if (toolResult.success) {
                        // Check if it's weather or currency data
                        if (toolResult.data.temperature !== undefined) {
                            toolResponseMsg = `Weather data retrieved: ${JSON.stringify(toolResult.data)}`;
                        } else if (toolResult.data.rate !== undefined) {
                            toolResponseMsg = `Exchange rate data retrieved: ${JSON.stringify(toolResult.data)}`;
                        } else if (toolResult.data.total_sales !== undefined) {
                            toolResponseMsg = `Sales data retrieved: ${JSON.stringify(toolResult.data)}`;
                        } else {
                            toolResponseMsg = `Data retrieved: ${JSON.stringify(toolResult.data)}`;
                        }
                    } else {
                        toolResponseMsg = `Error: ${toolResult.error}`;
                    }
                    
                    messages.push({role: "system", content: toolResponseMsg});
                    
                    // Get final AI response with weather data
                    showTyping();
                    
                    const finalResponse = await fetch(DEEPSEEK_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: messages,
                            temperature: 0.7,
                            max_tokens: 1000,
                            stream: false
                        })
                    });
                    
                    hideTyping();
                    
                    if (finalResponse.ok) {
                        const finalData = await finalResponse.json();
                        const finalMsg = finalData.choices[0].message.content;
                        addMessage(finalMsg, 'ai');
                        messages.push({role: "assistant", content: finalMsg});
                    }
                } else {
                    // Normal AI response (no tool call)
                    addMessage(aiMsg, 'ai');
                    messages.push({role: "assistant", content: aiMsg});
                }
                
            } catch (error) {
                hideTyping();
                addMessage('Error: Tidak dapat terhubung ke AI. Periksa koneksi atau API key.', 'ai error');
                console.error(error);
            } finally {
                sendBtn.disabled = false;
                input.focus();
            }
        }
        
        sendBtn.onclick = sendMessage;
        input.onkeypress = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        };
        
        // Welcome message
        addMessage('Halo! Saya AI assistant yang bisa membantu Anda dengan berbagai pertanyaan, termasuk informasi cuaca, kurs mata uang terkini, dan laporan penjualan. Coba tanya: "Bagaimana cuaca di Jakarta?", "Berapa kurs USD ke IDR?", atau "Tunjukkan laporan penjualan mingguan"', 'ai');
        
        // Instructions for API key
        if (WEATHER_API_KEY === 'YOUR_OPENWEATHER_API_KEY') {
            addMessage('‚ö†Ô∏è Untuk mendapatkan data cuaca yang akurat, silakan daftar di openweathermap.org untuk mendapatkan API key gratis, lalu ganti YOUR_OPENWEATHER_API_KEY di kode. Saat ini menggunakan layanan cadangan.', 'tool-call');
        }

        // Mock API for /api/sales
        const mockSalesData = {
            daily: {
                period: 'Harian',
                total_sales: 15750000,
                transactions: 123,
                top_product: 'Kopi Susu Gula Aren'
            },
            weekly: {
                period: 'Mingguan',
                total_sales: 105800000,
                transactions: 890,
                top_product: 'Nasi Goreng Spesial'
            },
            monthly: {
                period: 'Bulanan',
                total_sales: 450250000,
                transactions: 3450,
                top_product: 'Paket Ayam Geprek'
            }
        };

        // Intercept fetch calls to /api/sales
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (url.toString().startsWith('/api/sales')) {
                const urlParams = new URLSearchParams(url.split('?')[1]);
                const period = urlParams.get('period') || 'daily';
                return Promise.resolve({
                    ok: true,
                    json: () => Promise.resolve(mockSalesData[period])
                });
            }
            return originalFetch.apply(this, arguments);
        };
    </script>
</body>
</html>